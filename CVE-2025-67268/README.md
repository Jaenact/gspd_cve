# CVE-2025-67268: Heap-based Out-of-Bounds Write in NMEA2000 Driver (PGN 129540 Handling)

## Description

A heap-based out-of-bounds write vulnerability was discovered in the NMEA2000 driver of gpsd. The vulnerability exists in the `hnd_129540` function (handling PGN 129540: GNSS Satellites in View) within `drivers/driver_nmea2000.c`.

The function blindly trusts the satellite count field (`bu[2]`) from the incoming packet and uses it as a loop counter to write data into the `session->gpsdata.skyview` array. Since the `skyview` array has a fixed size (MAX_CHANNELS, typically around 184), a malicious packet specifying a satellite count larger than this (e.g., 255) causes the loop to write past the end of the array, corrupting adjacent memory on the heap.

## Affected Versions

- gpsd versions prior to 3.27.1.

## Impact

- **Denial of Service (DoS)**: The out-of-bounds write can corrupt critical internal structures on the heap, leading to a daemon crash or causing the process to enter an inconsistent state where it can no longer serve clients properly.
- **Memory Corruption**: The vulnerability allows writing arbitrary satellite data (elevation, azimuth, SNR) into heap memory adjacent to the `skyview` array. Depending on the memory layout and adjacent objects, this can lead to unpredictable behavior or corruption of other active sessions.

## Attack Vector

An attacker with access to the CAN bus (NMEA2000 network) or a compromised device on the network can inject a malicious PGN 129540 Fast Packet.

## Root Cause

Missing boundary check for `satellites_visible`.
The code directly assigns the packet's byte value to `satellites_visible` without checking if it exceeds `MAX_CHANNELS`.

```c
// Vulnerable code snippet
session->gpsdata.satellites_visible = (int)bu[2];
// ...
for (l1=0; l1 < session->gpsdata.satellites_visible; l1++) {
    // Writes out of bounds when satellites_visible > MAX_CHANNELS
    session->gpsdata.skyview[l1].elevation = ...;
}
```

## Proof of Concept

**Note**: Full exploit code is withheld for responsible disclosure.

Concept-level description:

1.  **Transport**: NMEA2000 (CAN bus).
2.  **Packet**: PGN 129540 (GNSS Satellites in View).
3.  **Payload**: Construct a packet where the satellite count byte (offset 2) is set to 255 (0xFF).
4.  **Result**: The processing loop runs 255 times, writing data beyond the `skyview` array limit, causing a heap overflow.

## Fix

Fixed in commit: [Commit Hash]
(Check the `gpsd` repository or GitLab for the specific commit merging the fix).

The fix involves clamping the satellite count to `MAX_CHANNELS` before starting the loop.

## Timeline

- Discovered: 2025
- Reported to vendor: 2025
- Fixed: 2025
- CVE assigned: December 17, 2025
- Public disclosure: December 21, 2025

## Credits

- Discovered by: Jaehyun Lee
